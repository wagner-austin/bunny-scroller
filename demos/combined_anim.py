"""Combined bunny and tree animation with proper layering."""
import sys
from blessed import Terminal

BUNNY_FRAMES = [
    """\
       +-
      #-+-
      #-+--##+.        -----
      #+#+---#.    #+++-----++.
  ..#+-#---#..###+-------------++.
 -+------------------------------#.
 +--+#+--++---------------++------#.++.
-#+---++++++----------+++++--------#.+.
 -++###++##+++----++++++##-------++#-
          .#++++++++#+++#++----++#.
              +##++++##.###++++++#.
                -+-+#+#    .#++++.
               .#+++#++# +#--++#.
               +++++-++  -+++++""",
    """\
     +#
   .#--#   .--.
   .#--#  ++--#
    -+++#+.--#.    ...###---+##.
  --###+-++-  --+##-------------++. ..
 ++-------++++--------------------++.+.
-+-+#++----+--------------+-------+#+-
.+-+---+++++-------+-+++++++-----+#-
 ..##-.##+++++++++++++++###+++-----#
       -#+++++#+####+       -##+++-++
     -+--++###.                .#-+++
   .+-++##+++-.                #-++#.
    -+++  ++                   .++.
                                   """,
    """\

   .-.                    ----- .+-
   #-#. -+++-        -#+++-----++-.#
   #-#..#-.++  ..+#---------------#
   .++#-.++  -++------------------#
   .++++###++-----------+++------+#
 +-------+------------++++++------+#.
.+-+#+----+--------++++++##++++----++.
-#----++++++++++++++++##.. .-#++++---#.
 +#####    #+++++###+           -##+-+-
          #---####-                #++#
       .#+++#-#++-.                ###.
       ++++  -++-
                                   """,
    """\
     +#
    -+-+.   .--        .---
     ++++  ++--#   .#+++---+++#
      #++#+---# .+-------------++.
       ##+-++.--+----------------+-.-
   #+++---++++----------++---------#.+.
  #--##----+---------+++++--------++#+.
 ++-----++++------++++++#+++----+++#-
 .##+++##+++++-++++++###-#+++++++#.
          #++++####        ###++#-
          -+-+#.#++-      -+++-++.
         +-++#. -++#     ++-+##.
        -+++   .+++       ++-
                                   """,
]

TREE_FRAMES = [
    """\
                     ..   ..
                    ..-. ...
                    .-.-....
                    ..-.--.-.
                    .---.-...    ..  ...
                 ... .-.-...    .--..-.-
            . .  ..--..-...  ...+-+.-..
           .---. ..-.--..   ..-.++----.
            .-..- .------.----+----.--.
             ..-.-.-+...-----.+--+--+-
         .-.-...-.-.--.......-.-----. .
          -.....-..-----.- ..-...  . ..-+
            ---..- .--.-.-..----.-.+++++
              .--...--....-.-+++-+++++-   -++-
            ...- .---..------.-.-+++--.--+++--....-.
      .     .-----+++-..-+++--+++-+- --++++++.......
   ..-... .--.----.--+-.-+#---+++-.-+++++++--..-...--
   . .......-.-++.+++.+.+.#-..-.--.-----..-.+.-.....
    .-.---...-..--.-++--..# ..-....-...-..-...--..
         .... .-+-.--+..--#--   .-  ..---..-.-..
 .....  .....+-+.. ..+----#........---.-...-
 -.-.-...+.-+.-.-..- .--+-#--...---..-.----.. ....
  ----.---+----+--...-.-.+#-----+-...---++--+.---.
     .-+-+++---.-.....--..#+-.-+---....--+--+++-.
     ----     . ... ......++... .-----
            ......-....-  -#.+....---++.
            . .-....-.  . .+.-..-.  ..-+
         ..-.-.  ..--    .+#  .-.
         -.      --.      ++                      .
                          #-            -            .
                          #.
              .           #
                          #         .
                          #
                          #
                          #.
                          #-
                          #+
                          ##
                          -#
                          .#.
                           .
                .     ..  ...     . .   ....     .........
                               ...... ....................
                                   ...      .............""",
    """\
                     ..   ..
                    ..-. ...
                    .-.-....
                    ..----.-.
                    .---.-...    ..  ...
                 ... .-.-...    .--..-.-
            . .  ..--..-...  ...--+.-.-
           .---. ..-.--..   ..-.++----.
            .-..- .------..--------.--.
             ..-.-.-+...-----.+--+--+-
         .-.-...-.-.--.......-.---+-. .
          -.....-..------- ..-...  . .--+
            ---..- .--.-.-..----...+++++
              .--...--....-.-+++-+++++-   --+-
            ...- .---..------.-.-+++--.---++--....-.
      .     .-----+++-..-+++--+++-+- --++++++..-....
   ....-. .--.----.--++.-+#---+++-.-+++++++--..-...--
   . .......-.-++.+++.-.+.#-..-.--.-----..-.+.-.....
    .-.---...-..--.-++--..# ..-....-...-..-...--..
         .-.. .-+-.--+..--#--   .-  ..---..-.-..
 -....  -....+-+.. ..+----#........---.-...-
 -.-.-..-+.-+.-.-..- .--+-#.-...---..-.----.. ....
  ----.---+----+--...-.-.+#-----+-...---++--+.-.-.
     .-+++++-----.....--..#+-.-+---....--+--+++--
     ----.    . -.. ......++... .-----
            ......-....-  -#.+....---++.
            ...-....-.  . .+.-..-.  ..-+
         ......  ..--    .+#  .-              .
         -.      --.      ++                      .
                          #-                          .
                          #.
                          #
                          #          -           -
                          #
                          #
                          #.
                          #-
                          #+
                          ##
                          -#
                          .#.
                           .
                .     ..  ...     . .   ....     .........
                               ...... ....................
                                   ...      .............""",
    """\
                      ....  .
                      ........
                      ..--....
                     ...--....
                  .  ...--....          .
                 .-......-...   .......--
            ...   ..--......  ...---...-
           .-.--  .----.... .-.--+-.-. .
            .-..-....--......-.+----..-.
              .-..-.-...-.-..--.-+-..-.
           -........-.-..--..-.--.---.
            ...-.. ---++.. ..-..-.    .+..
             .-.....---...---..-....+--+--
               ...-..-....-..---.-+++-+..  .-.-.
             ..-. .--...------.--+-+---....+--+. ...
             ...-.---+..--+-..+.+++...--+-+++-..--.-
   .-..-..-.-.-..--..----.#.----+-.---++++++-----.....
    ........-..-..+++--+.-#...--.+-..-+--....-.-...--.
       .----....-----++.--# ....--.-......-.-..---..
         .-. ..-+-----....#.- . ...  ..-...---..
 ....   . .....-...----.--+-........-.....
 ....-..--.----..... ..-+-+--.....-..-.--.--.
  .---..----------...-.-.+#-..---....----+++.-.+..
    ..---+-+--..-......--.+-..-+---...-.-++-.--.+-
       .       ...........++..-..-.---.       .
            ......-....-  -#-+....-.---+.-
         .--....-...-   . .#.  ..--
        .-.-.. ...-.     .+#              .
                ..   ..   +-
                          #-
                          #.
                          #
                          #
                          #
                          #                       .
                          #.
                          #-               .
                          #+
                          ##
                          -#
                          .#.

                .     ..  ..            ...         ......
                             .... .. .....................
                                     ..     .............""",
    """\
                     ....  .
                     ..-.....
                    ..-.-....
                    ...--...-.
                     .---....       .  .
                 .....-.-...    ..--....
             .   ...-.......  ..---.-..
          .....  ...--....  ..-.-----..
           ....-...----...-.---+.--....
             .-..-.---..---.-.----.+-.
          ...-..-..--.-........-..-.. .
          ....- ...-----.....-.-.   .--..
           ..--.....--.-.-.---.-.-.+----.
               ..-...--...-..---.++--+-.   ..
            .-.. ...-..------.---+++--...-+---+.....
     -...   .-...-.--.-..++--.+-++-..--+++++++....-.
    ....-...--....--.-----#.----+-.--+-++++-----..-..
     .-...----.-..+-+---.-#...--.-..-++-..- .---....-
        ..--....--.--+-.--# ..-..-.-......-.-..---..
   .     .-.. .--..---...-#.- .-.. . ..--..---..
  .-....-..-...-.. -.----.#- ......--.....
   ...-------.-..... ..-+-#-......-....-.-.-.  .
    .-+--..-------.-.-.-.+#-...++.......--+-.+.+.-.
     ..-.-+---..-.......-.#-..-+---..-----++-+-++-
     .          . ......-.+#..- .-.---.    .       .
            ......-....-  .#-+... ...--+.
         .-...........  . .#....-.  .. ..
        ...-..  .....    .+#    .
         .        .       ++
                          #-                            ..
                          #.
                          #
                          #
                          #
                          #
                          #.
                          #-                         .
                          #+
                          ##
                          -#
                          .#.
                           .
                   .  ... ...    ..    ....       ........
                             ......   ....................
                                   .  .     .. ...........""",
]


class Screen:
    """Double-buffered screen with dirty tracking."""

    def __init__(self, term):
        self.term = term
        self.width = term.width
        self.height = term.height - 1
        self.current = [[' '] * self.width for _ in range(self.height)]
        self.previous = [[' '] * self.width for _ in range(self.height)]

    def clear(self):
        """Clear current buffer."""
        for row in self.current:
            for i in range(len(row)):
                row[i] = ' '

    def draw_sprite(self, lines, x, y):
        """Draw sprite to current buffer (non-space chars only)."""
        for i, line in enumerate(lines):
            row = y + i
            if 0 <= row < self.height:
                for j, ch in enumerate(line):
                    col = x + j
                    if 0 <= col < self.width and ch != ' ':
                        self.current[row][col] = ch

    def render(self, out):
        """Output only changed characters."""
        for row in range(self.height):
            for col in range(self.width):
                if self.current[row][col] != self.previous[row][col]:
                    out(self.term.move_xy(col, row) + self.current[row][col])
                    self.previous[row][col] = self.current[row][col]


def main():
    term = Terminal()
    bunny_idx = 0
    tree_idx = 0
    tree_x = -62

    out = sys.stdout.write
    flush = sys.stdout.flush

    with term.fullscreen(), term.cbreak(), term.hidden_cursor():
        out(term.home + term.clear)
        flush()

        screen = Screen(term)

        while True:
            screen.clear()

            # Draw tree (background)
            tree_lines = TREE_FRAMES[tree_idx].split('\n')
            tree_y = screen.height - len(tree_lines)
            screen.draw_sprite(tree_lines, tree_x, tree_y)

            # Draw bunny (foreground)
            bunny_lines = BUNNY_FRAMES[bunny_idx].split('\n')
            bunny_x = term.width // 2 - 20
            bunny_y = screen.height - len(bunny_lines)
            screen.draw_sprite(bunny_lines, bunny_x, bunny_y)

            # Render changes only
            screen.render(out)
            out(term.move_xy(0, term.height - 1) + "Press 'q' to quit")
            flush()

            key = term.inkey(timeout=0.10)
            if key.lower() == 'q':
                break

            bunny_idx = (bunny_idx + 1) % len(BUNNY_FRAMES)
            tree_idx = (tree_idx + 1) % len(TREE_FRAMES)

            tree_x += 2
            if tree_x > term.width:
                tree_x = -62


if __name__ == "__main__":
    main()
